<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-99.9.9">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>pde_code_generation – Don Willcox</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 1em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./mesoscale.html" rel="next">
<link href="./neutrino_quantum_kinetics.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-a0649ace7b9e9e15dfb5fe311d767a49.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-494121dfa8658343c03537e94414993d.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-dark-af231170390d1188270e08b790325b83.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-f54b82a95975cfe4b79b2d74db20ff9b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./research/gallery/willcox_lbl_hs_circ.png" alt="a photo of me" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Don Willcox</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-research" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Research</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-research">    
        <li>
    <a class="dropdown-item" href="./research.html">
 <span class="dropdown-text">Research Highlights</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./thermonuclear_supernovae.html">
 <span class="dropdown-text">Thermonuclear Supernovae</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./nuclear_reactions.html">
 <span class="dropdown-text">Nuclear Reactions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./ml_reactions.html">
 <span class="dropdown-text">Machine Learning For Surrogate Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./neutron_stars.html">
 <span class="dropdown-text">Neutron Stars</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./neutrino_quantum_kinetics.html">
 <span class="dropdown-text">Neutrino Quantum Kinetics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./pde_code_generation.html">
 <span class="dropdown-text">Solving PDEs With Code Generation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./mesoscale.html">
 <span class="dropdown-text">Energy Research and Forecasting</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./compsci_philosophy.html">
 <span class="dropdown-text">Computational Science Philosophy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./research_horizons.html">
 <span class="dropdown-text">What’s Next?</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./codes.html"> 
<span class="menu-text">Codes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./talks.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./cv.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./bio.html"> 
<span class="menu-text">Bio</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:eugene.willcox@gmail.com"> <i class="bi bi-envelope-at-fill" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dwillcox"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./pde_code_generation.html">Solving PDEs With Code Generation</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./research.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research Highlights</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./thermonuclear_supernovae.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Thermonuclear Supernovae</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nuclear_reactions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Nuclear Reactions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ml_reactions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Machine Learning For Surrogate Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./neutron_stars.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neutron Stars</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./neutrino_quantum_kinetics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neutrino Quantum Kinetics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pde_code_generation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Solving PDEs With Code Generation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mesoscale.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Energy Research and Forecasting</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./compsci_philosophy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computational Science Philosophy</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./research_horizons.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">What’s Next?</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#solving-pdes-with-code-generation" id="toc-solving-pdes-with-code-generation" class="nav-link active" data-scroll-target="#solving-pdes-with-code-generation">Solving PDEs With Code Generation</a>
  <ul class="collapse">
  <li><a href="#creating-stvar-to-generate-adaptive-mesh-eulerian-pde-solvers" id="toc-creating-stvar-to-generate-adaptive-mesh-eulerian-pde-solvers" class="nav-link" data-scroll-target="#creating-stvar-to-generate-adaptive-mesh-eulerian-pde-solvers">Creating STvAR To Generate Adaptive-Mesh Eulerian PDE Solvers</a></li>
  <li><a href="#stvar-enables-users-to-leap-into-solving-pdes-with-high-performance-computing" id="toc-stvar-enables-users-to-leap-into-solving-pdes-with-high-performance-computing" class="nav-link" data-scroll-target="#stvar-enables-users-to-leap-into-solving-pdes-with-high-performance-computing">STvAR Enables Users To Leap Into Solving PDEs With High-Performance Computing</a></li>
  <li><a href="#stvar-generated-code-narrows-predicted-limits-on-hypothetical-axion-dark-matter" id="toc-stvar-generated-code-narrows-predicted-limits-on-hypothetical-axion-dark-matter" class="nav-link" data-scroll-target="#stvar-generated-code-narrows-predicted-limits-on-hypothetical-axion-dark-matter">STvAR-Generated Code Narrows Predicted Limits On Hypothetical Axion Dark Matter</a></li>
  <li><a href="#code-generation-for-lagrangian-pde-solvers" id="toc-code-generation-for-lagrangian-pde-solvers" class="nav-link" data-scroll-target="#code-generation-for-lagrangian-pde-solvers">Code Generation For Lagrangian PDE Solvers</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/dwillcox/dwillcox.github.io/blob/main/pde_code_generation.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/dwillcox/dwillcox.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>
<script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    toggleBodyColorPrimary();
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        disableStylesheet(primaryStylesheets)
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const darkModeDefault = false;
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>




<section id="solving-pdes-with-code-generation" class="level1">
<h1>Solving PDEs With Code Generation</h1>
<p>Scientists frequently work to understand complicated space-time dynamics or conservation laws by describing their evolution using Partial Differential Equations (PDEs). Simply put, PDEs predict how a quantity evolves by calculating derivatives in space and time.</p>
<p>While at Berkeley Lab, I worked with other computational scientists to create automated code generation methods for solving PDE systems using either Eulerian or Lagrangian techniques.</p>
<p>Our codes are open-source, and our methods are generally useful for a wide variety of scientific contexts where PDEs exist or could be devised but would be challenging to solve. We can translate symbolic PDEs into high performance code very simply and create a simulation package ready to run on modern GPU-accelerated supercomputers.</p>
<p>If you would like to collaborate on such research, you are always welcome to reach out.</p>
<section id="creating-stvar-to-generate-adaptive-mesh-eulerian-pde-solvers" class="level2">
<h2 class="anchored" data-anchor-id="creating-stvar-to-generate-adaptive-mesh-eulerian-pde-solvers">Creating STvAR To Generate Adaptive-Mesh Eulerian PDE Solvers</h2>
<p>As part of the ExaStar team within the DOE Exascale Computing Project, I worked with Adam Peterson to solve the numerical general relativity equations using the AMReX framework for block-structured adaptive mesh refinement.</p>
<p>The Einstein equations are notoriously tricky to solve numerically, so we first had to decide on a reliable numerical technique that we could also combine with ExaStar solvers for hydrodynamics or radiation transport.</p>
<p>We chose the Method of Lines numerical technique, which replaces all spatial derivatives with finite-difference derivatives. The Method of Lines technique leaves the time derivatives in the equations symbolic, but it tells us exactly how to compute them using finite-difference discretization for all the other terms in the PDEs.</p>
<p>However, the Einstein equations are notoriously lengthy when expanded into numerical form. Translating hundreds of arithmetic terms into computer code would be laborious and it would be very easy to make mistakes.</p>
<p>We needed a fast, reliable solution, so we turned to symbolic code generation based on the open-source Python package for symbolic mathematics, Sympy. Sympy is capable of translating symbolic expressions into C++ or Fortran computer code.</p>
<p>We used Sympy to write STvAR, a Python and C++ framework. The Python part of STvAR uses Sympy to discretize all the spatial partial derivatives appearing in a general set of PDEs using finite differencing up to fourth order. After replacing all continuous spatial derivatives with finite differences, we rearrange our PDEs to define the continuous time derivatives, still symbolic. STvAR then generates code to compute all the PDE time derivatives in C++.</p>
<p>The STvAR C++ framework then incorporates the generated C++ time derivatives with preprocessor <code>include</code> statements. Our C++ solver framework then reads user-supplied initial conditions and evolves the PDEs forward in time using a variety of Runge-Kutta explicit time integration methods up to fourth order. We use the AMReX framework to provide block-structured adaptive mesh refinement, and we symbolically generate our refinement tagging C++ code.</p>
</section>
<section id="stvar-enables-users-to-leap-into-solving-pdes-with-high-performance-computing" class="level2">
<h2 class="anchored" data-anchor-id="stvar-enables-users-to-leap-into-solving-pdes-with-high-performance-computing">STvAR Enables Users To Leap Into Solving PDEs With High-Performance Computing</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Get STvAR
</div>
</div>
<div class="callout-body-container callout-body">
<p>STvAR is freely available at the <a href="https://github.com/AMReX-Astro/STvAR">STvAR GitHub</a>.</p>
</div>
</div>
<p>STvAR thus provides computational scientists with an easy way to get started solving their PDE systems. STvAR generates high-performance, portably parallel code that leverages adaptive mesh refinement to focus computational resources where they are most needed.</p>
<p>Users just starting out with high performance computing do not need to understand all the finer details of multi-level synchronization or parallel ghost cell communication in order for their solver to get up and running. STvAR handles all these algorithmic details automatically with sensible default options. Once the code is running, users can take advantage of all the general domain decomposition and refinement customization options AMReX supports simply by reviewing the AMReX documentation and altering their inputs files, no C++ required.</p>
<p>STvAR enabled us to create a numerical solver for general relativity and then simulate black hole mergers to compute their radiated gravitational wave signature that an Earth-based detector like LIGO could measure.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="research/publications/pub0025/pub0025_inspiral_chirp.png" class="img-fluid figure-img"></p>
<figcaption>Simulated binary black hole inspiral traces black hole centers through (3+1) spacetime and radiates the characteristic chirp waveform.</figcaption>
</figure>
</div>
<p>We published our code generation validation work for general relativity in <span class="citation" data-cites="peterson_codegen_2023">Peterson et al. (<a href="#ref-peterson_codegen_2023" role="doc-biblioref">2023</a>)</span>.</p>
</section>
<section id="stvar-generated-code-narrows-predicted-limits-on-hypothetical-axion-dark-matter" class="level2">
<h2 class="anchored" data-anchor-id="stvar-generated-code-narrows-predicted-limits-on-hypothetical-axion-dark-matter">STvAR-Generated Code Narrows Predicted Limits On Hypothetical Axion Dark Matter</h2>
<p>Our code-generation research to solve numerical general relativity soon sparked interest in other fields.</p>
<p>Ben Safdi and his collaborators were coincidentally studying a hypothesized axion dark matter model they wished to solve on cosmological scales.</p>
<p>They contacted us wishing to use our code generation framework to solve the axion field equations with adaptive mesh refinement.</p>
<p>We worked with these dark matter researchers to construct a simulation code solving the axion field equations with high order finite differencing. The primary challenge was following the axion string evolution on the cosmological scales required, requiring careful adaptive mesh refinement.</p>
<p>Our collaboration enabled the team to simulate axion string evolution and radiation on cosmological spacetime scales with unprecedented resolution.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="research/publications/pub0019/pub0019_f1_axion_vr.png" class="img-fluid figure-img"></p>
<figcaption>Three-dimensional simulation evolving the axion field over cosmological time, illustrating the axion energy density and axion string structures at late times.</figcaption>
</figure>
</div>
<p>These new simulations tightened the current cosmological constraints on the range of axion mass-energy by more than a factor of three.</p>
<p>For details, see <span class="citation" data-cites="buschmann_axions_2022">Buschmann et al. (<a href="#ref-buschmann_axions_2022" role="doc-biblioref">2022</a>)</span>.</p>
</section>
<section id="code-generation-for-lagrangian-pde-solvers" class="level2">
<h2 class="anchored" data-anchor-id="code-generation-for-lagrangian-pde-solvers">Code Generation For Lagrangian PDE Solvers</h2>
<p>Sometimes Eulerian methods introduce too much artificial numerical diffusion into a set of PDEs where transport dominates the physics of interest.</p>
<p>The reason for this is fundamentally that Eulerian methods represent the solution as values at fixed points in space, or as values corresponding to small volumes of space.</p>
<p>When physical matter moves across the domain, the underlying spatial grid remains fixed in place.</p>
<p>Depending on the discretization method, there may be smaller or larger amounts of numerical errors introduced as a result of this mis-match between physical transport and the underlying grid.</p>
<p>Lagrangian methods address this issue by simply moving the grid points or discrete volumes along with the physical matter they represent.</p>
<p>For arbitrary three dimensional flows, where turbulence is possible, this can quickly lead to a tangled grid. For this reason, Lagrangian techniques are generally chosen when the computational complexity of grid tangling can be avoided.</p>
<p>For example, astrophysical radiation can be modeled by assigning a Lagrangian particle in code to represent a set of physical photons or neutrinos. The AMReX framework we used for Eulerian AMR supports Lagrangian particles on adaptive meshes as well for such cases.</p>
<p>Code generation is still very useful when those particles have non-trivial evolution.</p>
<p>Suppose you are modeling neutrino radiation transport with Lagrangian particles, and you decide you need to evolve the neutrino quantum flavor state as well. This requires solving complex-valued equations associated with each particle as it travels, picking up source terms for that equation from nearby neutrinos.</p>
<p>To see how code generation and a general Lagrangian framework can successfully address this scenario, see my <a href="./neutrino_quantum_kinetics.html">Neutrino Quantum Kinetics research page</a>.</p>



</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="1" role="list">
<div id="ref-buschmann_axions_2022" class="csl-entry" role="listitem">
Buschmann, M., Foster, J. W., Hook, A., Peterson, A., Willcox, D. E., Zhang, W., &amp; Safdi, B. R. 2022, Nat Commun, 13, 1049, <a href="https://www.nature.com/articles/s41467-022-28669-y">https://www.nature.com/articles/s41467-022-28669-y</a>
</div>
<div id="ref-peterson_codegen_2023" class="csl-entry" role="listitem">
Peterson, A. J., Willcox, D., &amp; Mösta, P. 2023, Class Quantum Grav, 40, 245013, <a href="https://iopscience.iop.org/article/10.1088/1361-6382/ad0b37">https://iopscience.iop.org/article/10.1088/1361-6382/ad0b37</a>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(darkModeDefault) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    }
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./neutrino_quantum_kinetics.html" class="pagination-link" aria-label="Neutrino Quantum Kinetics">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Neutrino Quantum Kinetics</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./mesoscale.html" class="pagination-link" aria-label="Energy Research and Forecasting">
        <span class="nav-page-text">Energy Research and Forecasting</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2025, Don E. Willcox</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/dwillcox/dwillcox.github.io/blob/main/pde_code_generation.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/dwillcox/dwillcox.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>